#r "paket:
nuget Fake.Core.Environment prerelease
nuget Fake.Core.Globbing prerelease
nuget Fake.Core.Process prerelease
nuget Fake.DotNet.Cli prerelease
nuget Fake.DotNet.NuGet prerelease
nuget coveralls.io >= 1.4.2
nuget FSharp.Formatting >= 2.14.4
nuget FSharpLint.Fake >= 0.9.0
nuget NUnit >= 3.9.0
nuget YamlDotNet >= 4.3.0 //"
open System
open System.IO

open Fake.Core.Environment
open Fake.Core.Globbing.Tools
open Fake.Core.Process
open Fake.DotNet.Cli
open Fake.DotNet.NuGet.Restore

open Microsoft.Win32


// Really bootstrap 
let dotnetPath = "dotnet" |> tryFindFileOnPath
let dotnetOptions = match dotnetPath with
                    | Some f -> {DotnetOptions.Default with DotnetCliPath = f}
                    | None -> DotnetOptions.Default

DotnetRestore (fun o -> { o with 
                            Packages = ["./packages"]
                            Common = dotnetOptions}) "./Build/dotnet-nuget.csproj"

// Restore the NuGet packages used by the build and the Framework version
let nuget = findNuget "." 
RestoreMSSolutionPackages id "./AltCover.sln"

// Get the paths to the current NuGet versions used by the build and feed into the primary build script
let cache0 = Path.Combine (Environment.GetFolderPath Environment.SpecialFolder.UserProfile,
                           ".nuget/packages")
let cache1 = ".paket"

let cache = if Directory.Exists cache1 then cache1 else cache0

let lint =  Path.Combine  (cache, "fsharplint.fake")                     
let lintlib = Directory.GetFiles(lint, "*SharpLint.Fake.dll", SearchOption.AllDirectories)
              |> Seq.last
              |> Path.GetDirectoryName

let md = Path.Combine  (cache, "fsharp.formatting") 
let mdlib = Directory.GetFiles(md, "*Sharp.Markdown.dll", SearchOption.AllDirectories)
            |> Seq.filter (fun n -> n.Contains("net40"))
            |> Seq.last
            |> Path.GetDirectoryName

let build = """// generated by dotnet fake run .\Build\setup.fsx
#r "paket:
nuget Fake.Core.Target prerelease
nuget Fake.Core.Environment prerelease
nuget Fake.Core.Globbing prerelease
nuget Fake.Core.Process prerelease
nuget Fake.DotNet.AssemblyInfoFile prerelease
nuget Fake.DotNet.Cli prerelease
nuget Fake.DotNet.MsBuild prerelease
nuget Fake.DotNet.NuGet prerelease
nuget Fake.DotNet.Testing.NUnit prerelease
nuget Fake.DotNet.Testing.OpenCover prerelease
nuget Fake.IO.FileSystem prerelease
nuget coveralls.io >= 1.4.2
nuget FSharp.Formatting >= 2.14.4
nuget FSharpLint.Fake >= 0.9.0
nuget NUnit >= 3.9.0
nuget YamlDotNet >= 4.3.0 //"
#I @"{0}"
#r "FSharpLint.Fake.dll"
#I @"{1}"
#r "FSharp.Markdown.dll"
#r "System.IO.Compression.FileSystem.dll"
#r "System.Xml"
#r "System.Xml.Linq"

#load "actions.fsx"
#load "targets.fsx"
"""

let formatted = String.Format(build, lintlib, mdlib)
File.WriteAllText("./Build/build.fsx", formatted)